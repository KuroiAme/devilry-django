{% extends "devilry_group/base.django.html" %}
{% load custom_filter %}
{% load crispy_forms_tags %}
{% load cradmin_icon_tags %}
{% load i18n %}

{% block title %}
    {{ assignment.get_path }}
{% endblock title %}

{% block jsimports %}
    {{ block.super }}
    {% load static %}

    <script src="{% static 'devilry_group/src/js/devilry_group.js'%}"></script>
{% endblock jsimports %}

{% block pageheader-inner %}
    <div class="row">
        <div class="devilry-group-feedbackfeed-header">
            <div class="col-sm-7 text-left">
                <h1>{{ assignment.long_name }}</h1>
                <p>{{ subject.long_name }} {{ period.long_name }}</p>
            </div>
            <div class="col-sm-5 text-right">
                <h2 class="devilry-group-feedbackfeed-current-deadline-heading">
                    {% trans "Current deadline" %}
                </h2>
                <p class="devilry-group-feedbackfeed-current-current-deadline
                            {% if current_date >= last_feedbackset.deadline_datetime %}
                                devilry-group-feedbackfeed-current-current-deadline-expired
                            {% endif %}">
                    {% if current_date >= last_feedbackset.deadline_datetime %}
                        <span class="devilry-group-feedbackfeed-current-current-deadline-expired-label">
                            {% trans "Expired" %} -
                        </span>
                    {% endif %}
                    <span class="devilry-group-feedbackfeed-current-current-deadline-datetime">
                        {{ last_deadline|date:"SHORT_DATETIME_FORMAT" }}
                    </span>
                </p>
            </div>
        </div>
    </div>
{% endblock pageheader-inner %}

{% block content %}

<!-- Content -->
    <div class="container">

        <div class="devilry-group-feedbackfeed-sidebar scrollable" django-cradmin-scroll-top-fixed='{"pinToTopOnScroll":true}'  ng-app="devilryGroupTestApp" ng-controller="devilryGroupSidebarContentCollapse">
                {% block sidebar %}
                    <h4 ng-click="toggleSidebarContentCollapse('isUploadedFilesCollapsed')"><a href="">{% trans "Uploaded files" %}</a></h4>
                    <div collapse="isUploadedFilesCollapsed">
                            {% for feedbackset in feedbacksets %}
                                <dl>
                                    <dt>
                                        {% blocktrans with counter=''|devilry_verbosenumber:forloop.counter %}{{ counter }} deadline{% endblocktrans %}
                                    </dt>
                                    {% for comment in feedbackset.groupcomment_set.all %}
                                        {% for file in comment.commentfile_set.all %}
                                            <dd class="devilry-group-feedbackfeed-sidebar-files">
                                                <a href="#" >{{ file.filename|devilry_truncatefileextension:26 }}</a>
                                            </dd>
                                        {% endfor %}
                                    {% endfor %}
                                </dl>
                            {% endfor %}
                        </div>

                    <h4 ng-click="toggleSidebarContentCollapse('isTextFormattingCollapsed')"><a href=""> {% trans "Text formatting" %}</a></h4>
                        <div collapse="isTextFormattingCollapsed">
                            {% include "devilry_group/feedbackfeedsidebar_markdown_text.html" %}
                        </div>

                    <h4 ng-click="toggleSidebarContentCollapse('isCodeFormattingCollapsed')"><a href="">{% trans "Code formatting" %}</a></h4>
                        <div collapse="isCodeFormattingCollapsed">
                            {% include "devilry_group/feedbackfeedsidebar_markdown_code.html" %}
                        </div>

                    <h4 ng-click="toggleSidebarContentCollapse('isMathFormattingCollapsed')"><a href="">{% trans "Math formatting" %}</a></h4>
                        <div collapse="isMathFormattingCollapsed">
                            <p>Todo</p>
                            <p>Todo</p>
                            <p>Todo</p>
                            <p>Todo</p>
                            <p>Todo</p>
                        </div>

                {% endblock sidebar %}
                </div>
            </div>


        <div class="row">
            <!--
            Sidebar
            -->
            <div class="col-md-4 col-md-push-8"></div>

            <div class="col-md-8 col-md-pull-4 devilry-group-feedbackfeed-feed">
                {% block feed %}

                    {% for timestamp, eventlist in timeline.items %}
                        {% for event in eventlist %}

                            <!--
                            Handle comments events
                            -->
                            {% if event.type == "comment" %}
                                {% with event.obj as comment %}
                                    <div class="
                                        devilry-group-feedbackfeed-comment
                                        {% if comment.user_role == "student" %}
                                            devilry-group-feedbackfeed-comment-student
                                        {% elif comment.user_role == "examiner"%}
                                            devilry-group-feedbackfeed-comment-examiner
                                        {% elif comment.user_role == "admin"%}
                                            devilry-group-feedbackfeed-comment-admin
                                        {% endif %}" devilry-group-test-directive="nisse">
                                        <div class="devilry-group-feedbackfeed-comment-content">
                                            <div class="comment-meta">
                                                <div class="comment-created-by"><p>{{ comment.user }}&nbsp;</p></div>
                                                <div class="comment-created-by-role"><p>({{ comment.user_role }})&nbsp;</p></div>
                                                <div class="comment-created-date"><p> {{ comment.published_datetime }}</p></div>
                                            </div>
                                            <div class="comment-text">
                                                {% blocktrans with text=comment.text|devilry_group_markdown|safe %} {{text}} {% endblocktrans %}
                                            </div>
                                            {% for file in comment.commentfile_set.all %}
                                                <div class="file_icon"><p>{{ file.filename }}</p></div>
                                            {% endfor %}
                                        </div>
                                        {% if not comment.instant_publish and not comment.feedback_set.published_datetime %}
                                            <div class="devilry-group-feedbackfeed-right-badge-field not-published-badge">
                                                <p class="badge-text">{% trans "NOT PUBLISHED" %}</p>
{#                                                <p class="badge-text-new">{% trans "NOT PUBLISHED" %}</p>#}
                                            </div>
                                        {% elif comment.user_role == "student" and comment.published_datetime > comment.feedback_set.deadline_datetime %}
                                            <div class="devilry-group-feedbackfeed-right-badge-field after-deadline-badge">
                                                <p class="badge-text">{% trans "NOT PART OF DELIVERY" %}</p>
{#                                                <p class="badge-text-new">{% trans "NOT PART OF DELIVERY" %}</p>#}
                                            </div>

                                        {% endif %}
                                    </div>
                                {% endwith %}

                                <!--
                                Handle the deadline events
                                -->
                                {% elif event.type == "deadline_created" %}
                                    <div class="event-message">
                                        <p>
                                            {{ timestamp }}: {{ event.user }} {%  trans "created a new deadline" %}: <strong>{{ event.obj }}</strong>
                                        </p>
                                    </div>
                                {% elif event.type == "deadline_expired" %}
                                    <div class="event-message">
                                        <p>
                                            {{ timestamp }}: <strong> {% trans "Deadline expired" %}</strong>
                                        </p>
                                    </div>

                                <!--
                                Handle feedback grade events
                                -->
                                {% elif event.type == "grade" %}
                                    {% if event.obj >= assignment.passing_grade_min_points %}
                                        <div class="event-message-passed">
                                            <p>{{ timestamp }}: {% trans "This delivery was corrected, and given the grade" %}
                                                <strong>{{ event.obj }}/{{ assignment.max_points }} {% trans "(passed)" %}</strong>
                                            </p>
                                        </div>
                                    {% else %}
                                        <div class="event-message-failed">
                                            <p>
                                                {{ timestamp }}: {% trans "This delivery was corrected, and given the grade" %}
                                                <strong>{{ event.obj }}/{{ assignment.max_points }} {%  trans "(failed)" %}</strong>
                                            </p>
                                        </div>
                                    {% endif %}
                            {% endif %}

                        {% endfor %}
                    {% endfor %}


                    {% block pre_form %}{% endblock pre_form %}
                    {% block form %}
                        {% crispy form formhelper %}

                        {% comment %}
                            NOTE: This will probably break when https://github.com/maraujop/django-crispy-forms/issues/263 is fixed
                        {% endcomment %}
                        {{ form.media }}
                    {% endblock form %}
                    {% block post_form %}{% endblock post_form %}


                {% endblock feed %}
              </div>



{% endblock content %}

{% block initialize_angular %}
    <script>
        angular.module('djangoCradminUi', ['djangoCradmin', 'devilryGroupTestApp'])
    </script>
{% endblock initialize_angular %}